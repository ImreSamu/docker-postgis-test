name: TEST - Docker PostGIS CI

# testing : https://github.com/postgis/docker-postgis/pull/432
# original author: https://github.com/BowlesCR

on:
  push:
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: '15 13 * * *'


defaults:
  run:
    shell: bash

env:
  DOCKERHUB_REPO: imresamu/docker-postgis-test
  GITHUB_REPO: ImreSamu/docker-postgis-test

jobs:

  constants:
    # This job resolves configuration constants that can be used in job-level and step-level 'if' conditions.
    # GitHub Actions 'if' conditions cannot access top-level 'env' variables directly,
    # so we compute them here and expose them as job outputs.
    # This allows fork-friendly configuration: forks can override values using Repository Variables,
    # while the original repository uses the defaults defined in top-level 'env'.
    # The SHOULD_PUBLISH flag centralizes the complex publishing condition in one place.
    name: Init
    runs-on: ubuntu-latest
    outputs:
      CANONICAL_REPO: ${{ steps.set.outputs.CANONICAL_REPO }}
      SHOULD_PUBLISH: ${{ steps.set.outputs.SHOULD_PUBLISH }}
    steps:
      - id: set
        env:
          VAR_CANONICAL: ${{ vars.CANONICAL_REPO }}
        run: |
          CANONICAL_REPO="${VAR_CANONICAL:-$GITHUB_REPO}"
          echo "CANONICAL_REPO=$CANONICAL_REPO" >> "$GITHUB_OUTPUT"

          # Compute if we should publish
          if [[ "${{ github.repository }}" == "$CANONICAL_REPO" ]] && \
             [[ "${{ github.ref }}" == "refs/heads/master" ]] && \
             [[ "${{ github.event_name }}" != "pull_request" ]]; then
            echo "SHOULD_PUBLISH=true" >> "$GITHUB_OUTPUT"
          else
            echo "SHOULD_PUBLISH=false" >> "$GITHUB_OUTPUT"
          fi
  make-docker-images:
    needs: constants
    strategy:
      matrix:
        runner-platform: ['ubuntu-24.04', 'ubuntu-24.04-arm']
#        postgres: [13, 14, 15, 16, 17 ]
        postgres: [ 16, 17 ]
        postgis: ['3.5']
        variant: [default, alpine]
        include:
#          - postgres: 16
#            postgis: master
#            variant: default
#            runner-platform: 'ubuntu-24.04'
#          - postgres: 17
#            postgis: master
#            variant: default
#            runner-platform: 'ubuntu-24.04'
#          - postgres: 16
#            postgis: master
#            variant: default
#            runner-platform: 'ubuntu-24.04-arm'
#          - postgres: 17
#            postgis: master
#            variant: default
#            runner-platform: 'ubuntu-24.04-arm'
          - postgres: 17
            postgis: '3.6'
            variant: alpine
            runner-platform: 'ubuntu-24.04'
          - postgres: 17
            postgis: '3.6'
            variant: alpine
            runner-platform: 'ubuntu-24.04-arm'
          - postgres: 18
            postgis: '3.6'
            variant: alpine
            runner-platform: 'ubuntu-24.04'
          - postgres: 18
            postgis: '3.6'
            variant: alpine
            runner-platform: 'ubuntu-24.04-arm'
          - postgres: 18
            postgis: '3.6'
            variant: default
            runner-platform: 'ubuntu-24.04'
          - postgres: 18
            postgis: '3.6'
            variant: default
            runner-platform: 'ubuntu-24.04-arm'

    name: "Build:${{ matrix.postgres }}-${{ matrix.postgis }}-${{ matrix.variant }} (${{ contains(matrix.runner-platform, 'arm') && 'arm64' || 'x86-64' }}) Docker image"
    runs-on: ${{ matrix.runner-platform }}
    continue-on-error: ${{ matrix.postgis == 'master' }}
    env:
      VERSION: ${{ matrix.postgres }}-${{ matrix.postgis }}
      VARIANT: ${{ matrix.variant }}
      CI_IMAGE_TAG: postgisXXX/postgis:ci-${{ github.run_id }}-${{ matrix.postgres }}-${{ matrix.postgis }}-${{ matrix.variant }}-${{ contains(matrix.runner-platform, 'arm') && 'arm' || 'x64' }}

    steps:
    - name: Checkout source
      uses: actions/checkout@v5

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image for ${{ env.VERSION }} ${{ env.VARIANT }}
      id: build
      uses: docker/build-push-action@v5
      with:
        context: ${{ env.VERSION }}${{ env.VARIANT == 'alpine' && '/alpine' || ''}}
        file: ${{ env.VERSION }}${{ env.VARIANT == 'alpine' && '/alpine' || ''}}/Dockerfile
        tags: ${{ env.CI_IMAGE_TAG }}
        load: true
        push: false  # don't push until after testing

    - name: Check out official-images repo
      uses: actions/checkout@v5
      with:
        repository: docker-library/official-images
        path: official-images
        sparse-checkout: |
          test

    - name: Run official-images test script
      run: |
        ./official-images/test/run.sh -c ./official-images/test/config.sh -c test/postgis-config.sh "$CI_IMAGE_TAG" | tee test.log

    - name: Verify test results
      run: |
        if ! grep -q "'postgres-basics'.*passed" test.log || \
           ! grep -q "'postgres-initdb'.*passed" test.log || \
           ! grep -q "'postgis-basics'.*passed" test.log; then
          echo "ERROR: Required PostGIS tests did not pass!"
          exit 1
        fi
        echo "âœ“ All required tests passed"

    - name: Login to dockerhub
      id: login-dockerhub
      uses: docker/login-action@v3
      if: ${{ needs.constants.outputs.SHOULD_PUBLISH == 'true' }}
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_ACCESS_TOKEN }}

    - name: Push image by digest
      id: push
      uses: docker/build-push-action@v5  # Build is cached, this is really just a push
      if: ${{ needs.constants.outputs.SHOULD_PUBLISH == 'true' && steps.login-dockerhub.outcome == 'success' }}
      with:
        context: ${{ env.VERSION }}${{ env.VARIANT == 'alpine' && '/alpine' || ''}}
        file: ${{ env.VERSION }}${{ env.VARIANT == 'alpine' && '/alpine' || ''}}/Dockerfile
        outputs: type=image,"name=${{ env.DOCKERHUB_REPO }}",push-by-digest=true,name-canonical=true,push=true

    - name: Export digest
      if: ${{ steps.push.outcome == 'success' }}
      run: |
        mkdir -p ${{ runner.temp }}/digests
        digest="${{ steps.push.outputs.digest }}"
        touch "${{ runner.temp }}/digests/${digest#sha256:}"

    - name: Upload digests
      if: ${{ steps.push.outcome == 'success' }}
      uses: actions/upload-artifact@v4
      with:
        name: digests-${{ env.VERSION }}-${{ env.VARIANT }}-${{ matrix.runner-platform }}
        path: ${{ runner.temp }}/digests/*
        if-no-files-found: error
        retention-days: 10

  merge-manifests:
    name: "Merge:${{ matrix.postgres }}-${{ matrix.postgis }}-${{ matrix.variant }} manifests and push to DockerHub"
    needs: [constants, make-docker-images]
    runs-on: ubuntu-24.04-arm  # Always on arm, because why not
    if: ${{ needs.constants.outputs.SHOULD_PUBLISH == 'true' }}
    continue-on-error: ${{ matrix.postgis == 'master' }}
    env:
      VERSION: ${{ matrix.postgres }}-${{ matrix.postgis }}
      VARIANT: ${{ matrix.variant }}
    strategy:
      matrix:
        # Copy from above, minus the runner-platform
#        postgres: [13, 14, 15, 16, 17]
        postgres: [ 16, 17]
        postgis: ['3.5']
        variant: [default, alpine]
        include:
#          - postgres: 16
#            postgis: master
#            variant: default
#          - postgres: 17
#            postgis: master
#            variant: default
          - postgres: 17
            postgis: '3.6'
            variant: alpine
          - postgres: 18
            postgis: '3.6'
            variant: alpine
          - postgres: 18
            postgis: '3.6'
            variant: default

    steps:
    - name: Login to dockerhub
      id: login-dockerhub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_ACCESS_TOKEN }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Download digests
      uses: actions/download-artifact@v4
      with:
        path: ${{ runner.temp }}/digests
        pattern: digests-${{ env.VERSION }}-${{ env.VARIANT }}-*
        merge-multiple: true

    - name: Docker Metadata
      uses: docker/metadata-action@v5
      with:
        images: |
          ${{ env.DOCKERHUB_REPO }}
        tags: |
          type=raw,value=${{ env.VERSION }}${{ env.VARIANT == 'alpine' && '-alpine' || ''}}

    - name: Create manifest list and push
      working-directory: ${{ runner.temp }}/digests
      run: |
        docker buildx imagetools create $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
          $(printf '${{ env.DOCKERHUB_REPO }}@sha256:%s ' *)

    - name: Inspect image  # Purely for debugging
      run: |
        sleep 5
        docker buildx imagetools inspect ${{ env.DOCKERHUB_REPO }}:${{ env.VERSION }}${{ env.VARIANT == 'alpine' && '-alpine' || ''}}
